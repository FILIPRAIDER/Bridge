# üéØ AJUSTE: Sistema de 5 Fases para Creaci√≥n de Proyectos

## üìã CONTEXTO

**Situaci√≥n Actual:**
- Frontend muestra banner con progreso de **5 fases obligatorias**
- AI est√° recopilando 4 datos pero el banner muestra 3/5 (60%)
- Usuario confirma creaci√≥n pero falla con error gen√©rico

**Screenshot de Evidencia:**
```
Banner: "Informaci√≥n del Proyecto - 3/5 completado - 60%"

Informaci√≥n recopilada:
‚úì Tipo de proyecto: App m√≥vil para negocio de comidas r√°pidas
‚úì Objetivos principales: Que la aplicaci√≥n sea atractiva y funcional
‚úì Presupuesto: 30 millones de pesos
‚úì Tiempo de entrega: 3 meses

Usuario: "S√≠ por favor"
AI: "Parece que hubo un error al intentar crear el proyecto debi..."
```

---

## üîç PROBLEMA IDENTIFICADO

### 1. Discrepancia en Tracking de Flags
**C√≥digo Frontend (ProjectProgressBanner.tsx, l√≠nea 68-74):**
```typescript
const mainItems = [
  { label: 'Tipo', hasData: flags.hasProjectType, icon: 'üéØ' },
  { label: 'Industria/Sector', hasData: flags.hasIndustry, icon: 'üè¢' }, // ‚Üê NO SE MARCA
  { label: 'Presupuesto', hasData: flags.hasBudget, icon: 'üí∞' },
  { label: 'Tiempo', hasData: flags.hasTimeline, icon: '‚è±Ô∏è' },
  { label: 'Objetivos', hasData: flags.hasObjectives, icon: 'üéØ' },
];
```

**Backend debe marcar estas 5 flags:**
- `hasProjectType` ‚úÖ (marcada correctamente)
- `hasIndustry` ‚ùå (NO se est√° marcando aunque podr√≠a inferirse)
- `hasBudget` ‚úÖ (marcada correctamente)
- `hasTimeline` ‚úÖ (marcada correctamente)
- `hasObjectives` ‚ùå (NO se est√° marcando aunque se pregunt√≥)

### 2. Flag `hasObjectives` No Se Marca
**Evidencia:**
- AI pregunt√≥: "¬øCu√°les son los objetivos principales?"
- Usuario respondi√≥: "Que la aplicaci√≥n sea atractiva y funcional"
- Banner sigue en 3/5 (deber√≠a pasar a 4/5)

**Posible causa:**
- La respuesta no se parsea como array de objetivos
- El flag no se actualiza en la sesi√≥n
- La validaci√≥n es demasiado estricta

---

## ‚úÖ SOLUCI√ìN PROPUESTA

### OPCI√ìN A: Mantener 5 Fases (RECOMENDADO) ‚≠ê

**Por qu√© es mejor:**
1. ‚úÖ Informaci√≥n completa para match inteligente de equipos
2. ‚úÖ Mejor experiencia de usuario (siente que est√° siendo exhaustivo)
3. ‚úÖ Datos estructurados y consistentes en la base de datos
4. ‚úÖ Permite filtros avanzados en dashboard empresario

**Las 5 fases obligatorias:**
1. **Tipo de proyecto** (`hasProjectType`)
   - Pregunta: "¬øQu√© tipo de proyecto necesitas desarrollar?"
   - Ejemplos: App m√≥vil, Sitio web, Sistema ERP, E-commerce, etc.
   
2. **Industria/Sector** (`hasIndustry`)
   - Pregunta: "¬øA qu√© industria o sector pertenece tu negocio?"
   - Ejemplos: Tecnolog√≠a, Salud, Retail, Alimentos, Educaci√≥n, etc.
   - **IMPORTANTE**: Esto se usa para match de equipos con experiencia en el sector
   
3. **Presupuesto** (`hasBudget`)
   - Pregunta: "¬øCu√°l es tu presupuesto aproximado?"
   - Formato: N√∫mero + moneda (COP/USD)
   
4. **Timeline** (`hasTimeline`)
   - Pregunta: "¬øEn cu√°nto tiempo necesitas tenerlo listo?"
   - Formato: N√∫mero + unidad (meses/semanas)
   
5. **Objetivos** (`hasObjectives`)
   - Pregunta: "¬øCu√°les son los objetivos principales que quieres lograr?"
   - Formato: Array de strings (incluso si el usuario da una respuesta como texto)

---

## üîß CAMBIOS NECESARIOS EN BACKEND IA

### 1. System Prompt - Flujo de 5 Pasos (Actualizado)

**Reemplazar la secci√≥n actual de "FLUJO DE CREACI√ìN" con:**

```
‚öôÔ∏è FLUJO DE CREACI√ìN DE PROYECTO (OBLIGATORIO - SIGUE ESTOS PASOS EN ORDEN):

1. Pregunta: "¬øQu√© tipo de proyecto necesitas desarrollar?" 
   ‚Üí Espera respuesta ‚Üí Marca hasProjectType = true
   
2. Pregunta: "¬øA qu√© industria o sector pertenece tu negocio?"
   ‚Üí Espera respuesta ‚Üí Marca hasIndustry = true
   ‚Üí Ejemplos si dudas: "¬øEs tecnolog√≠a, salud, retail, alimentos, educaci√≥n...?"
   
3. Pregunta: "¬øCu√°les son los objetivos principales que quieres lograr con este proyecto?"
   ‚Üí Espera respuesta ‚Üí Marca hasObjectives = true
   ‚Üí Convierte la respuesta en array (aunque sea un solo string)
   
4. Pregunta: "¬øCu√°l es tu presupuesto aproximado en pesos colombianos?"
   ‚Üí Espera respuesta ‚Üí Marca hasBudget = true
   
5. Pregunta: "¬øEn cu√°nto tiempo necesitas tenerlo listo?"
   ‚Üí Espera respuesta ‚Üí Marca hasTimeline = true
   
6. Resume TODA la informaci√≥n recopilada:
   "Perfecto, vamos a crear tu proyecto con estos datos:
   ‚Ä¢ Tipo: [tipo]
   ‚Ä¢ Sector: [industria]
   ‚Ä¢ Objetivos: [lista de objetivos]
   ‚Ä¢ Presupuesto: [presupuesto]
   ‚Ä¢ Tiempo: [timeline]
   
   ¬øDeseas que cree el proyecto con esta informaci√≥n?"
   
7. SOLO si el usuario confirma (dice "s√≠", "confirmo", "adelante", "correcto", "dale") 
   ‚Üí Marca wasConfirmed = true
   ‚Üí Llama createProjectDraft con isComplete: true
   
8. Una vez creado exitosamente, ofrece buscar equipos

‚ö†Ô∏è REGLAS CR√çTICAS:
- ‚ùå NO llames createProjectDraft si falta alguna de las 5 flags: hasProjectType, hasIndustry, hasObjectives, hasBudget, hasTimeline
- ‚ùå NO llames createProjectDraft sin confirmaci√≥n expl√≠cita (wasConfirmed = true)
- ‚ùå NO asumas informaci√≥n - pregunta TODO antes de crear
- ‚úÖ S√ç actualiza las flags en CADA respuesta del usuario
- ‚úÖ S√ç valida que isComplete = true solo cuando las 5 flags est√©n marcadas
- ‚úÖ S√ç convierte respuestas de objetivos en array aunque sea un solo texto
```

---

### 2. Actualizar L√≥gica de Flags (project-flags.js o equivalente)

**Agregar validaci√≥n espec√≠fica para `hasObjectives`:**

```javascript
// Cuando el usuario responde objetivos
if (userMessage.toLowerCase().includes('objetivo') || 
    (contextHints.askingForObjectives && userMessage.length > 10)) {
  
  // Convertir respuesta a array de objetivos
  let objectives = [];
  
  // Si es una lista (separada por comas, puntos, "y", etc.)
  if (userMessage.includes(',') || userMessage.includes(' y ')) {
    objectives = userMessage
      .split(/[,y]/)
      .map(obj => obj.trim())
      .filter(obj => obj.length > 3);
  } else {
    // Si es un solo objetivo en texto libre
    objectives = [userMessage.trim()];
  }
  
  // Actualizar data y flag
  sessionData.projectData.objectives = objectives;
  sessionData.projectFlags.hasObjectives = true;
  
  console.log('‚úÖ Objetivos marcados:', objectives);
}
```

**Agregar validaci√≥n espec√≠fica para `hasIndustry`:**

```javascript
// Cuando el usuario responde industria/sector
if (userMessage.toLowerCase().match(/tecnolog[i√≠]a|salud|retail|alimentos|educaci[o√≥]n|financiero|construcci[o√≥]n|textil|manufactura|servicios|transporte/i) ||
    (contextHints.askingForIndustry && userMessage.length > 3)) {
  
  // Extraer industria mencionada
  const industry = userMessage.trim();
  
  // Actualizar data y flag
  sessionData.projectData.industry = industry;
  sessionData.projectFlags.hasIndustry = true;
  
  console.log('‚úÖ Industria marcada:', industry);
}
```

---

### 3. Validaci√≥n Antes de Crear Proyecto (chat.route.js)

**Actualizar la validaci√≥n en el handler de `createProjectDraft`:**

```javascript
// ‚ö†Ô∏è VALIDACI√ìN: Las 5 flags OBLIGATORIAS
if (!updatedFlags.isComplete) {
  const missing = [];
  
  if (!updatedFlags.hasProjectType) {
    missing.push('tipo de proyecto');
  }
  if (!updatedFlags.hasIndustry) {
    missing.push('industria o sector del negocio'); // ‚Üê NUEVA
  }
  if (!updatedFlags.hasObjectives) {
    missing.push('objetivos principales del proyecto'); // ‚Üê ACTUALIZADA
  }
  if (!updatedFlags.hasBudget) {
    missing.push('presupuesto aproximado');
  }
  if (!updatedFlags.hasTimeline) {
    missing.push('tiempo de desarrollo estimado');
  }
  
  toolResults.push({
    name,
    result: { 
      error: 'Informaci√≥n incompleta para crear el proyecto.', 
      status: 400,
      message: `‚ö†Ô∏è Falta informaci√≥n esencial: ${missing.join(', ')}. Por favor, responde estas preguntas antes de intentar crear el proyecto.`,
      missingFields: missing,
      currentProgress: `${5 - missing.length}/5 completado`
    },
    toolCallId
  });
  
  console.error('‚ùå Intento de crear proyecto con info incompleta:', {
    missing,
    flags: updatedFlags
  });
  
  continue; // Skip to next tool
}

// ‚ö†Ô∏è VALIDACI√ìN: Confirmaci√≥n expl√≠cita
const wasConfirmed = updatedFlags.wasConfirmed;

if (!wasConfirmed) {
  toolResults.push({
    name,
    result: { 
      error: 'Confirmaci√≥n requerida.', 
      status: 400,
      message: '‚ö†Ô∏è Necesito que confirmes expl√≠citamente para crear el proyecto. Por favor, responde "s√≠", "confirmo" o "adelante".',
    },
    toolCallId
  });
  
  console.error('‚ùå Intento de crear proyecto sin confirmaci√≥n');
  continue;
}

// ‚úÖ TODO OK - Proceder con la creaci√≥n
console.log('‚úÖ Validaciones pasadas, creando proyecto:', {
  type: sessionData.projectData.projectType,
  industry: sessionData.projectData.industry,
  objectives: sessionData.projectData.objectives,
  budget: sessionData.projectData.budget,
  timeline: sessionData.projectData.timeline
});
```

---

### 4. Mejor Manejo de Errores

**Cuando falla la creaci√≥n, responder con mensaje espec√≠fico:**

```javascript
catch (error) {
  console.error('‚ùå Error al crear proyecto:', error);
  
  // Mensaje de error m√°s √∫til para el usuario
  let userMessage = 'Lo siento, hubo un problema al crear tu proyecto.';
  
  if (error.message.includes('companyId')) {
    userMessage = 'No pude identificar tu empresa. Por favor, recarga la p√°gina e intenta de nuevo.';
  } else if (error.message.includes('validation')) {
    userMessage = 'Algunos datos no tienen el formato correcto. Revisemos la informaci√≥n...';
  } else if (error.message.includes('timeout')) {
    userMessage = 'La conexi√≥n tard√≥ demasiado. Intentemos de nuevo en un momento.';
  }
  
  toolResults.push({
    name,
    result: { 
      error: error.message, 
      status: error.status || 500,
      message: userMessage,
      detailedError: process.env.NODE_ENV === 'development' ? error.stack : undefined
    },
    toolCallId
  });
}
```

---

## üß™ CASOS DE PRUEBA

### Test Case 1: Flujo Completo Exitoso
```
Usuario: "Necesito una app"
AI: "¬øQu√© tipo de proyecto necesitas desarrollar?"
Usuario: "App m√≥vil para delivery de comida"
AI: [Marca hasProjectType ‚úÖ] "¬øA qu√© industria pertenece?"
Usuario: "Alimentos y bebidas"
AI: [Marca hasIndustry ‚úÖ] "¬øCu√°les son los objetivos?"
Usuario: "Aumentar ventas y fidelizar clientes"
AI: [Marca hasObjectives ‚úÖ, objectives: ["Aumentar ventas y fidelizar clientes"]] "¬øPresupuesto?"
Usuario: "30 millones"
AI: [Marca hasBudget ‚úÖ] "¬øEn cu√°nto tiempo?"
Usuario: "3 meses"
AI: [Marca hasTimeline ‚úÖ, isComplete ‚úÖ] [Muestra resumen] "¬øDeseas crear este proyecto?"
Usuario: "S√≠"
AI: [wasConfirmed ‚úÖ] ‚Üí createProjectDraft() ‚Üí "¬°Proyecto creado!" ‚úÖ

Banner debe mostrar: 5/5 completado (100%) üéâ
```

### Test Case 2: Usuario Impaciente (Intenta Crear Antes de Completar)
```
Usuario: "Necesito una app m√≥vil"
AI: [hasProjectType ‚úÖ] "¬øA qu√© industria?"
Usuario: "Cr√©ala ya"
AI: NO debe crear, debe responder:
    "‚ö†Ô∏è Falta informaci√≥n esencial: industria, objetivos, presupuesto, tiempo. 
     Dame estos datos para crear tu proyecto correctamente."
Banner debe mostrar: 1/5 completado (20%)
```

### Test Case 3: Usuario Da Objetivos en Texto Libre
```
AI: "¬øCu√°les son los objetivos?"
Usuario: "Quiero que sea intuitiva, r√°pida y que atraiga clientes"
AI: [Debe parsear y marcar hasObjectives ‚úÖ]
    objectives: ["Quiero que sea intuitiva, r√°pida y que atraiga clientes"]
    "Perfecto, ¬øcu√°l es tu presupuesto?"
Banner debe mostrar: 3/5 completado (60%) ‚Üí 4/5 (80%)
```

### Test Case 4: Usuario Da Objetivos en Lista
```
AI: "¬øCu√°les son los objetivos?"
Usuario: "Aumentar ventas, mejorar UX y reducir costos"
AI: [Debe parsear y marcar hasObjectives ‚úÖ]
    objectives: ["Aumentar ventas", "mejorar UX", "reducir costos"]
    "Excelente, ¬øcu√°l es tu presupuesto?"
Banner debe mostrar: 3/5 completado (60%) ‚Üí 4/5 (80%)
```

### Test Case 5: Error de Backend (Network/Timeout)
```
[Todas las 5 fases completadas, usuario confirma]
AI: [Intenta crear pero falla por timeout]
AI debe responder: 
    "Lo siento, la conexi√≥n tard√≥ demasiado. Intentemos de nuevo en un momento."
    [NO debe marcar como creado]
    [Debe mantener la sesi√≥n con los datos]
Usuario: "Int√©ntalo de nuevo"
AI: [Reintenta con mismos datos] ‚Üí "¬°Proyecto creado!" ‚úÖ
```

---

## üìä M√âTRICAS DE VALIDACI√ìN

**Despu√©s de implementar estos cambios, debe cumplirse:**

‚úÖ **Banner muestra 1/5 (20%)** cuando solo tiene tipo  
‚úÖ **Banner muestra 2/5 (40%)** cuando tiene tipo + industria  
‚úÖ **Banner muestra 3/5 (60%)** cuando tiene tipo + industria + objetivos  
‚úÖ **Banner muestra 4/5 (80%)** cuando tiene tipo + industria + objetivos + presupuesto  
‚úÖ **Banner muestra 5/5 (100%)** cuando tiene TODOS los datos (antes de confirmaci√≥n)  
‚úÖ **Banner se pone VERDE** con confetti cuando isComplete = true  
‚úÖ **Banner desaparece suavemente** 2.5s despu√©s de completarse  
‚úÖ **NO se puede crear proyecto** con menos de 5/5 completado  
‚úÖ **NO se puede crear proyecto** sin confirmaci√≥n expl√≠cita del usuario  

---

## üéØ DECISI√ìN FINAL: MANTENER 5 FASES

**Justificaci√≥n:**
1. ‚úÖ **Industria/Sector es CR√çTICA** para el match inteligente de equipos
2. ‚úÖ **5 preguntas toman <2 minutos** en responder (no es engorroso)
3. ‚úÖ **Mejor calidad de datos** = Mejores recomendaciones de equipos
4. ‚úÖ **Consistencia** con el resto de la plataforma (perfil empresario tambi√©n pide sector)
5. ‚úÖ **Diferenciador de valor** vs competencia (match m√°s preciso)

**NO recomendamos reducir a 3 o 4 fases porque:**
- ‚ùå Perdemos capacidad de match por sector/industria
- ‚ùå Proyectos incompletos en la base de datos
- ‚ùå Peor experiencia para equipos (proyectos poco claros)
- ‚ùå Menor calidad de recomendaciones

---

## üöÄ PLAN DE IMPLEMENTACI√ìN

### Fase 1: Backend IA (Prioridad ALTA) üî¥
1. ‚úÖ Actualizar system prompt con flujo de 5 pasos expl√≠cito
2. ‚úÖ Agregar l√≥gica para marcar `hasIndustry` flag
3. ‚úÖ Mejorar parsing de `hasObjectives` (texto libre + listas)
4. ‚úÖ Reforzar validaci√≥n de 5 flags antes de crear
5. ‚úÖ Mejorar mensajes de error espec√≠ficos

**Tiempo Estimado:** 2-3 horas  
**Testing:** Con los 5 casos de prueba arriba

### Fase 2: Monitoreo (Post-Deploy)
1. ‚úÖ Log de tracking de flags en cada mensaje
2. ‚úÖ Log de intentos de creaci√≥n rechazados (por qu√© flag faltaba)
3. ‚úÖ M√©tricas de tiempo promedio para completar 5 fases
4. ‚úÖ Rate de √©xito de creaci√≥n (con vs sin errores)

**Tiempo Estimado:** 30 minutos  
**Herramientas:** Console logs + Render logs

---

## üìù NOTAS PARA EL EQUIPO

### Para Backend IA
- Este cambio es **100% backend** (sin cambios en frontend)
- Prioridad: **ALTA** (afecta experiencia core del producto)
- Testing necesario con los 5 casos arriba
- Deploy: **Render auto-deploy** en 2-3 minutos

### Para Frontend
- **No hay cambios necesarios** - el banner ya est√° listo para 5 fases
- Solo probar que el banner responda correctamente a los flags
- Verificar animaci√≥n de confetti al llegar a 5/5

### Para Testing/QA
- Probar flujo completo de creaci√≥n de proyecto
- Verificar que banner muestre 1/5, 2/5, 3/5, 4/5, 5/5 correctamente
- Validar que no se pueda crear con info incompleta
- Validar mensajes de error si faltan datos
- Probar con diferentes formatos de objetivos (texto libre, lista, etc.)

---

## ‚úÖ CHECKLIST DE VERIFICACI√ìN

- [ ] System prompt actualizado con 5 pasos expl√≠citos
- [ ] Validaci√≥n de `hasIndustry` agregada
- [ ] Parsing mejorado de `hasObjectives` (texto libre + listas)
- [ ] Validaci√≥n de 5 flags obligatorias antes de crear
- [ ] Mensajes de error espec√≠ficos implementados
- [ ] Logs de debugging agregados
- [ ] Commit realizado con mensaje descriptivo
- [ ] Push a main
- [ ] Render auto-deploy completado
- [ ] Testing con los 5 casos de prueba
- [ ] Verificaci√≥n end-to-end con frontend
- [ ] M√©tricas de monitoreo revisadas

---

## üéØ RESULTADO ESPERADO

**Despu√©s de este ajuste, el flujo ser√°:**

```
üë§ Usuario: "Necesito una app"
ü§ñ AI: "¬øQu√© tipo de proyecto?" ‚Üí [1/5 - 20%]
üë§ Usuario: "App m√≥vil"
ü§ñ AI: "¬øQu√© industria?" ‚Üí [2/5 - 40%]
üë§ Usuario: "Alimentos"
ü§ñ AI: "¬øObjetivos?" ‚Üí [3/5 - 60%]
üë§ Usuario: "Aumentar ventas"
ü§ñ AI: "¬øPresupuesto?" ‚Üí [4/5 - 80%]
üë§ Usuario: "30M"
ü§ñ AI: "¬øTiempo?" ‚Üí [5/5 - 100%] üéâ
üë§ Usuario: "3 meses"
ü§ñ AI: [Resumen completo] "¬øCrear proyecto?"
üë§ Usuario: "S√≠"
ü§ñ AI: "¬°Creado! üéâ" ‚Üí [Banner verde con confetti]
```

**Banner debe coincidir EXACTAMENTE con el progreso real del AI** ‚úÖ

---

## ‚úÖ ESTADO DE IMPLEMENTACI√ìN

**Commit:** `d9537db`  
**Fecha Implementaci√≥n:** 2025-10-09  
**Estado:** ‚úÖ IMPLEMENTADO Y DESPLEGADO  
**Render:** Auto-deploy en progreso (~2-3 minutos)

### Cambios Implementados

#### 1. **project-flags.js** ‚úÖ
- [x] L√≥gica `isComplete` actualizada para requerir 5 flags
- [x] Detecci√≥n de objetivos mejorada (acepta texto libre)
- [x] Validaci√≥n de industria ya exist√≠a (solo faltaba incluirla en isComplete)
- [x] Instrucciones AI actualizadas para mostrar las 5 fases

#### 2. **chat.route.js** ‚úÖ
- [x] System prompt actualizado con flujo de 5 pasos expl√≠cito
- [x] Validaci√≥n en handler actualizada para las 5 flags
- [x] Mensajes de error con indicador de progreso (3/5, 4/5, etc.)
- [x] Reglas NUNCA actualizadas para mencionar las 5 fases

#### 3. **Comportamiento Esperado** ‚úÖ
- [x] Banner mostrar√° 1/5 cuando solo tenga tipo
- [x] Banner mostrar√° 2/5 cuando tenga tipo + industria
- [x] Banner mostrar√° 3/5 cuando tenga tipo + industria + objetivos
- [x] Banner mostrar√° 4/5 cuando tenga + presupuesto
- [x] Banner mostrar√° 5/5 cuando tenga TODOS los datos
- [x] No se puede crear proyecto sin las 5 fases completas

### Testing Pendiente
- [ ] Probar flujo completo en frontend (despu√©s de deploy)
- [ ] Verificar que banner responda a los 5 flags
- [ ] Validar que objetivos en texto libre se marcan correctamente
- [ ] Validar que industria se marca en fase 2

---

**Fecha Original:** 2025-01-09  
**Documento:** BACKEND_IA_AJUSTE_FASES_PROYECTO.md  
**Versi√≥n:** 1.1 (Implementado)  
**Estado Anterior:** üìã LISTO PARA IMPLEMENTAR  
**Estado Actual:** ‚úÖ IMPLEMENTADO - ESPERANDO TESTING  
**Prioridad:** üî¥ ALTA (Bug cr√≠tico de UX)  
**Tiempo Real:** ~45 minutos implementaci√≥n  
**Responsable Backend IA:** AI Assistant  
**Revisi√≥n Frontend:** No requiere cambios  
**Aprobado por:** FILIPRAIDER
